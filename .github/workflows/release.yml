name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true

env:
  CARGO_TERM_COLOR: always
  # Use input version for workflow_dispatch, extract from tag for push
  RELEASE_VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  validate-changelog:
    name: Validate Changelog
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref }}

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Check changelog has entry for this version
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Look for version heading in CHANGELOG.md
          # Matches: ## [v1.2.3], ## v1.2.3, ## [1.2.3], ## 1.2.3
          if grep -qE "^## \[?v?${VERSION}\]?" CHANGELOG.md; then
            echo "âœ“ Found changelog entry for v${VERSION}"
          else
            echo "::error::CHANGELOG.md is missing an entry for v${VERSION}"
            echo ""
            echo "Please add a changelog section before releasing:"
            echo ""
            echo "  ## [v${VERSION}] - $(date +%Y-%m-%d)"
            echo "  "
            echo "  ### Added"
            echo "  - New feature description"
            echo "  "
            echo "  ### Fixed"
            echo "  - Bug fix description"
            echo ""
            exit 1
          fi

  build-linux:
    name: Build Linux ${{ matrix.target }}
    needs: [validate-changelog]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
          - target: x86_64-unknown-linux-musl
          - target: aarch64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build with cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ../../../proj-${{ matrix.target }}.tar.gz proj
          cd ../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proj-${{ matrix.target }}
          path: proj-${{ matrix.target }}.tar.gz

  build-macos:
    name: Build macOS ${{ matrix.target }}
    needs: [validate-changelog]
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
          - target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ../../../proj-${{ matrix.target }}.tar.gz proj
          cd ../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proj-${{ matrix.target }}
          path: proj-${{ matrix.target }}.tar.gz

  build-windows:
    name: Build Windows
    needs: [validate-changelog]
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release

      - name: Package
        run: |
          cd target/release
          7z a ../../proj-x86_64-pc-windows-msvc.zip proj.exe
          cd ../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proj-x86_64-pc-windows-msvc
          path: proj-x86_64-pc-windows-msvc.zip

  release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref_name }}
          files: artifacts/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: [release]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Download and compute SHA256 hashes
        id: hashes
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"

          # Download and hash each platform
          for target in aarch64-apple-darwin x86_64-apple-darwin aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu; do
            echo "Downloading proj-${target}.tar.gz..."
            curl -sL "${BASE_URL}/proj-${target}.tar.gz" -o "/tmp/proj-${target}.tar.gz"
            HASH=$(sha256sum "/tmp/proj-${target}.tar.gz" | cut -d' ' -f1)
            echo "${target}=${HASH}" >> $GITHUB_OUTPUT
            echo "  ${target}: ${HASH}"
          done

      - name: Update Homebrew formula
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          FORMULA="packaging/homebrew/aiproject.rb"

          # Update version
          sed -i "s/version \".*\"/version \"${VERSION}\"/" "$FORMULA"

          # Update SHA256 hashes
          # This uses a Python script for reliable multi-line sed replacement
          python3 << 'PYTHON'
          import re

          hashes = {
              "aarch64-apple-darwin": "${{ steps.hashes.outputs.aarch64-apple-darwin }}",
              "x86_64-apple-darwin": "${{ steps.hashes.outputs.x86_64-apple-darwin }}",
              "aarch64-unknown-linux-gnu": "${{ steps.hashes.outputs.aarch64-unknown-linux-gnu }}",
              "x86_64-unknown-linux-gnu": "${{ steps.hashes.outputs.x86_64-unknown-linux-gnu }}",
          }

          with open("packaging/homebrew/aiproject.rb", "r") as f:
              content = f.read()

          for platform, sha in hashes.items():
              # Match url line containing platform, then update the next sha256 line
              pattern = rf'(url ".*{platform}.*"\n\s+)sha256 "[a-f0-9]+"'
              replacement = rf'\1sha256 "{sha}"'
              content = re.sub(pattern, replacement, content)

          with open("packaging/homebrew/aiproject.rb", "w") as f:
              f.write(content)

          print("Updated Homebrew formula")
          PYTHON

          cat "$FORMULA"

      - name: Commit and push formula update
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add packaging/homebrew/aiproject.rb
          git commit -m "Update Homebrew formula for v${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin main

  publish-npm:
    name: Publish to npm
    needs: [release]
    runs-on: ubuntu-latest
    if: ${{ vars.NPM_PUBLISH_ENABLED == 'true' }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish to npm
        run: |
          cd packaging/npm
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-vscode:
    name: Publish VS Code Extension
    needs: [release]
    runs-on: ubuntu-latest
    if: ${{ vars.VSCODE_PUBLISH_ENABLED == 'true' }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and build
        run: |
          cd vscode
          npm install
          npm run compile

      - name: Publish to VS Code Marketplace
        run: |
          cd vscode
          npm install -g @vscode/vsce
          vsce publish -p ${{ secrets.VSCE_PAT }}

  notify-on-failure:
    name: Notify on Failure
    needs: [validate-changelog, build-linux, build-macos, build-windows, release, update-homebrew, publish-npm, publish-vscode]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const tagName = context.ref.replace('refs/tags/', '');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Release ${tagName} failed`,
              body: `## Release Build Failed

            The automated release build for **${tagName}** has failed.

            ### What to do:

            1. **Check the workflow logs**: [View failed run](${runUrl})

            2. **Common issues:**
               - Build failures: Check compiler errors in the logs
               - Network issues: The workflow may need to be re-run
               - Permission issues: Check repository settings

            3. **To retry the release:**
               \`\`\`bash
               # Delete the tag
               git push --delete origin ${tagName}
               git tag -d ${tagName}

               # Fix the issue, then re-tag
               git tag ${tagName}
               git push --tags
               \`\`\`

            4. **If Homebrew formula update failed:**
               \`\`\`bash
               cd ~/projects/global/tools/proj
               proj release --check
               \`\`\`

            ---
            *This issue was automatically created by the release workflow.*
            `,
              labels: ['release', 'automated', 'needs-attention']
            });

  notify-success:
    name: Release Complete Notification
    needs: [update-homebrew, publish-npm, publish-vscode]
    if: always() && needs.update-homebrew.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "## âœ… Release v${VERSION} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Release (binaries for all platforms)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Homebrew formula updated" >> $GITHUB_STEP_SUMMARY
          if [ "${{ vars.NPM_PUBLISH_ENABLED }}" == "true" ]; then
            echo "- âœ… npm package (create-aiproj)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ npm package (disabled)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ vars.VSCODE_PUBLISH_ENABLED }}" == "true" ]; then
            echo "- âœ… VS Code Extension (marketplace)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ VS Code Extension (disabled)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install/Upgrade:" >> $GITHUB_STEP_SUMMARY
          echo "- \`brew upgrade proj\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`npm update -g create-aiproj\`" >> $GITHUB_STEP_SUMMARY
          echo "- [Download binaries](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})" >> $GITHUB_STEP_SUMMARY
