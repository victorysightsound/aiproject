name: Cleanup Old Workflow Runs

on:
  schedule:
    # Run weekly on Sunday at 2am UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      days_to_keep:
        description: 'Delete runs older than this many days'
        required: false
        default: '30'
      min_runs_to_keep:
        description: 'Minimum runs to keep per workflow'
        required: false
        default: '10'
      dry_run:
        description: 'Dry run (show what would be deleted)'
        required: false
        default: 'false'
        type: boolean

jobs:
  cleanup:
    name: Delete Old Runs
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const daysToKeep = parseInt('${{ inputs.days_to_keep }}' || '30');
            const minRunsToKeep = parseInt('${{ inputs.min_runs_to_keep }}' || '10');
            const dryRun = '${{ inputs.dry_run }}' === 'true';

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);

            console.log(`Configuration:`);
            console.log(`  - Delete runs older than: ${daysToKeep} days (before ${cutoffDate.toISOString()})`);
            console.log(`  - Keep at least: ${minRunsToKeep} runs per workflow`);
            console.log(`  - Dry run: ${dryRun}`);
            console.log('');

            // Get all workflows
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            let totalDeleted = 0;
            let totalSkipped = 0;

            for (const workflow of workflows.data.workflows) {
              console.log(`\nProcessing workflow: ${workflow.name} (${workflow.id})`);

              // Get all runs for this workflow
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.id,
                per_page: 100,
              });

              // Sort by created_at descending (newest first)
              const sortedRuns = runs.data.workflow_runs.sort(
                (a, b) => new Date(b.created_at) - new Date(a.created_at)
              );

              let keptCount = 0;
              let deletedCount = 0;

              for (const run of sortedRuns) {
                const runDate = new Date(run.created_at);
                const isOld = runDate < cutoffDate;
                const canDelete = keptCount >= minRunsToKeep;
                const isActive = run.status === 'in_progress' || run.status === 'queued';

                if (isActive) {
                  console.log(`  ‚è≥ Skipping active run #${run.run_number} (${run.status})`);
                  keptCount++;
                  totalSkipped++;
                } else if (isOld && canDelete) {
                  if (dryRun) {
                    console.log(`  üóëÔ∏è  Would delete run #${run.run_number} (${run.created_at})`);
                  } else {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id,
                    });
                    console.log(`  ‚úì Deleted run #${run.run_number} (${run.created_at})`);
                  }
                  deletedCount++;
                  totalDeleted++;
                } else {
                  keptCount++;
                  totalSkipped++;
                }
              }

              console.log(`  Summary: ${deletedCount} deleted, ${keptCount} kept`);
            }

            console.log(`\n========================================`);
            console.log(`Total: ${totalDeleted} runs ${dryRun ? 'would be ' : ''}deleted, ${totalSkipped} kept`);
