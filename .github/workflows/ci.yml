name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  check-release-needed:
    name: Check if Release Needed
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      issues: write
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Cargo.toml version
        id: cargo_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Cargo.toml version: $VERSION"

      - name: Get latest release tag
        id: latest_release
        run: |
          LATEST=$(git tag -l 'v*' | sort -V | tail -1 | sed 's/^v//' || echo "0.0.0")
          echo "LATEST=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST"

      - name: Check if release needed
        id: check
        run: |
          CARGO_VERSION="${{ steps.cargo_version.outputs.VERSION }}"
          LATEST="${{ steps.latest_release.outputs.LATEST }}"

          # Compare versions
          if [ "$(printf '%s\n' "$LATEST" "$CARGO_VERSION" | sort -V | tail -n1)" = "$CARGO_VERSION" ] && [ "$CARGO_VERSION" != "$LATEST" ]; then
            echo "NEEDS_RELEASE=true" >> $GITHUB_OUTPUT
            echo "Version $CARGO_VERSION is ahead of $LATEST - will auto-release"
          else
            echo "NEEDS_RELEASE=false" >> $GITHUB_OUTPUT
            echo "Version $CARGO_VERSION is not ahead of $LATEST - no release needed"
          fi

      - name: Create and push release tag
        if: steps.check.outputs.NEEDS_RELEASE == 'true'
        run: |
          VERSION="${{ steps.cargo_version.outputs.VERSION }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag "v${VERSION}"
          git push origin "v${VERSION}"
          echo "Created and pushed tag v${VERSION}"
          echo "Release workflow will be triggered automatically by the tag push"

  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy

      - name: Run clippy
        run: cargo clippy -- -A dead_code -A unused_imports -A unused_variables

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  notify-on-failure:
    name: Notify on CI Failure
    needs: [test, clippy, fmt]
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Check if there's already an open CI failure issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });

            if (issues.data.length > 0) {
              // Add a comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another CI failure occurred: [View run](${runUrl})\n\nCommit: ${context.sha}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”´ CI Build Failing on main',
                body: `## CI Build Failed

            The CI build on main branch is failing.

            **Failed run:** [View logs](${runUrl})
            **Commit:** ${context.sha}

            ### Quick fixes:
            - **Test failures:** Check test output in the logs
            - **Clippy warnings:** Run \`cargo clippy\` locally
            - **Format issues:** Run \`cargo fmt\` locally

            ---
            *This issue was automatically created. It will be closed when CI passes.*
            `,
                labels: ['ci-failure', 'automated']
              });
            }
