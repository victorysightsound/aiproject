name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  check-release-needed:
    name: Check if Release Needed
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Cargo.toml version
        id: cargo_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Cargo.toml version: $VERSION"

      - name: Get latest release tag
        id: latest_release
        run: |
          LATEST=$(git tag -l 'v*' | sort -V | tail -1 | sed 's/^v//' || echo "0.0.0")
          echo "LATEST=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST"

      - name: Compare versions and notify
        uses: actions/github-script@v7
        with:
          script: |
            const cargoVersion = '${{ steps.cargo_version.outputs.VERSION }}';
            const latestRelease = '${{ steps.latest_release.outputs.LATEST }}' || '0.0.0';

            function compareVersions(a, b) {
              const pa = a.split('.').map(Number);
              const pb = b.split('.').map(Number);
              for (let i = 0; i < 3; i++) {
                if (pa[i] > pb[i]) return 1;
                if (pa[i] < pb[i]) return -1;
              }
              return 0;
            }

            if (compareVersions(cargoVersion, latestRelease) > 0) {
              console.log(`Version ${cargoVersion} is ahead of latest release ${latestRelease}`);

              // Check for existing release reminder issue
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'release-reminder'
              });

              if (issues.data.length === 0) {
                // Create new issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸ“¦ Ready to release v${cargoVersion}`,
                  body: `## New Version Ready for Release

            **Cargo.toml version:** \`${cargoVersion}\`
            **Latest release:** \`v${latestRelease}\`

            The code version is ahead of the latest release. When you're ready to publish:

            ### Option 1: Use the release wizard (recommended)
            \`\`\`bash
            cd ~/projects/global/tools/proj
            proj release
            \`\`\`

            ### Option 2: Manual tag
            \`\`\`bash
            git tag v${cargoVersion}
            git push --tags
            \`\`\`

            The release workflow will automatically:
            - Build all platform binaries
            - Create GitHub release
            - Update Homebrew formula

            ---
            *This issue will close automatically when the release is created.*
            `,
                  labels: ['release-reminder', 'automated']
                });
                console.log('Created release reminder issue');
              } else {
                console.log('Release reminder issue already exists');
              }
            } else {
              console.log(`Version ${cargoVersion} is not ahead of ${latestRelease}, no release needed`);

              // Close any existing release reminder issues
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'release-reminder'
              });

              for (const issue of issues.data) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                console.log(`Closed release reminder issue #${issue.number}`);
              }
            }

  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy

      - name: Run clippy
        run: cargo clippy -- -D warnings

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  notify-on-failure:
    name: Notify on CI Failure
    needs: [test, clippy, fmt]
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Check if there's already an open CI failure issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });

            if (issues.data.length > 0) {
              // Add a comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another CI failure occurred: [View run](${runUrl})\n\nCommit: ${context.sha}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”´ CI Build Failing on main',
                body: `## CI Build Failed

            The CI build on main branch is failing.

            **Failed run:** [View logs](${runUrl})
            **Commit:** ${context.sha}

            ### Quick fixes:
            - **Test failures:** Check test output in the logs
            - **Clippy warnings:** Run \`cargo clippy\` locally
            - **Format issues:** Run \`cargo fmt\` locally

            ---
            *This issue was automatically created. It will be closed when CI passes.*
            `,
                labels: ['ci-failure', 'automated']
              });
            }
